#include <Arduino.h>
#include <Wire.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_Fingerprint.h>
#include <HardwareSerial.h>
#include <HTTPClient.h>
#include <time.h>
#include <Base64.h>
#include "FS.h"
#include "SPIFFS.h"
#include "esp_camera.h"

// OLED config
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Firebase Realtime Database URL (no trailing slash)
const char* FIREBASE_URL = "https://smart-door-3e8cc-default-rtdb.firebaseio.com";

// WiFi creds
const char* ssid = "Smriti";
const char* password = "Apple101";

// Mailjet creds
const char* mailjet_api_key = "4d59f9156740617c21649698c999c786";
const char* mailjet_api_secret = "b9b0bc9e2a3745c5295d116ae4a273f4";
const char* mailjet_from = "prashantzoce123@gmail.com";
const char* mailjet_to = "prashantzoce123@gmail.com";

const char* IMGBB_API_KEY = "417b2f643568e43ebba03a0641cf1608";
String latestImgbbUrl = "";


// Pins
#define GREEN_LED 2
#define RED_LED 4
#define BUZZER_TRIGGER_OUTPUT 10
#define motorPin1 38
#define motorPin2 39
#define motorPin3 40
#define motorPin4 41
const int stepsFor120Degrees = 1365;

HardwareSerial mySerial(1);
Adafruit_Fingerprint finger(&mySerial);

const int stepSequence[8][4] = {
  {1,0,0,0}, {1,1,0,0}, {0,1,0,0}, {0,1,1,0},
  {0,0,1,0}, {0,0,1,1}, {0,0,0,1}, {1,0,0,1}
};

WebServer server(80);
#define MAX_LOGS 20
String logs[MAX_LOGS];
int logCount = 0;

void addLog(const String &entry) {
  if (logCount < MAX_LOGS) logs[logCount++] = entry;
  else {
    for (int i = 1; i < MAX_LOGS; i++) logs[i-1] = logs[i];
    logs[MAX_LOGS - 1] = entry;
  }
}

String getTimeStamp() {
  time_t now; time(&now);
  struct tm t; localtime_r(&now, &t);
  char buf[20];
  strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", &t);
  return String(buf);
}

void sendToFirebase(const String& logEntry) {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String endpoint = String(FIREBASE_URL) + "/logs.json";
  http.begin(endpoint);
  http.addHeader("Content-Type", "application/json");

  String payload = "{\"log\":\"" + logEntry + "\"}";
  int code = http.POST(payload);
  Serial.println("Firebase code: " + String(code));
  http.end();
}

void sendMailjet(const String &subject, const String &text) {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  http.begin("https://api.mailjet.com/v3.1/send");
  http.addHeader("Content-Type", "application/json");

  String auth = String(mailjet_api_key) + ":" + mailjet_api_secret;
  String h = "Basic " + base64::encode(auth);
  http.addHeader("Authorization", h);

  String j =
    "{\"Messages\":[{\"From\":{\"Email\":\"" + String(mailjet_from) +
    "\"},\"To\":[{\"Email\":\"" + String(mailjet_to) +
    "\"}],\"Subject\":\"" + subject +
    "\",\"TextPart\":\"" + text + "\"}]}";

  int code = http.POST(j);
  Serial.println("Mailjet code: " + String(code));
  http.end();
}
bool uploadToImgBB(const String& imagePath) {
  File imageFile = SPIFFS.open(imagePath, "r");
  if (!imageFile) {
    Serial.println("âŒ Failed to open image for upload");
    return false;
  }
  String base64Image = "";
  uint8_t buf[512];
  while (imageFile.available()) {
    size_t len = imageFile.read(buf, sizeof(buf));
    base64Image += base64::encode(buf, len);
  }
  imageFile.close();
  HTTPClient http;
  String endpoint = "https://api.imgbb.com/1/upload?key=" + String(IMGBB_API_KEY);
  http.begin(endpoint);
  http.addHeader("Content-Type", "application/x-www-form-urlencoded");
  String payload = "image=" + base64Image;
  int httpCode = http.POST(payload);
  String response = http.getString();
  Serial.println("ðŸŸ¡ imgbb upload code: " + String(httpCode));
  if (httpCode == 200) {
    int start = response.indexOf("\"url\":\"") + 7;
    int end = response.indexOf("\"", start);
    latestImgbbUrl = response.substring(start, end);
    Serial.println("âœ… Uploaded to imgbb: " + latestImgbbUrl);
    return true;
  }
  Serial.println("âŒ Upload failed: " + response);
  return false;
}

void handleIntruderImageURL() {
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.send(200, "text/plain", latestImgbbUrl);
}
int getFingerprintID() {
  if (finger.getImage() != FINGERPRINT_OK) return -1;
  if (finger.image2Tz() != FINGERPRINT_OK) return -1;
  if (finger.fingerSearch() == FINGERPRINT_OK) return finger.fingerID;
  return -1;
}

void stepMotor(int step) {
  digitalWrite(motorPin1, stepSequence[step][0]);
  digitalWrite(motorPin2, stepSequence[step][1]);
  digitalWrite(motorPin3, stepSequence[step][2]);
  digitalWrite(motorPin4, stepSequence[step][3]);
}

void rotateMotorForward(int steps) {
  int stepIndex = 0;
  for (int i = 0; i < steps; i++) {
    stepMotor(stepIndex);
    stepIndex = (stepIndex + 1) % 8;
    delay(5);
  }
  digitalWrite(motorPin1, LOW); digitalWrite(motorPin2, LOW);
  digitalWrite(motorPin3, LOW); digitalWrite(motorPin4, LOW);
}

void rotateMotorBackward(int steps) {
  int stepIndex = 0;
  for (int i = 0; i < steps; i++) {
    stepMotor(stepIndex);
    stepIndex = (stepIndex + 7) % 8;
    delay(5);
  }
  digitalWrite(motorPin1, LOW); digitalWrite(motorPin2, LOW);
  digitalWrite(motorPin3, LOW); digitalWrite(motorPin4, LOW);
}

bool doorIsOpen = false;

void openDoor() {
  if (!doorIsOpen) {
    rotateMotorForward(stepsFor120Degrees);
    doorIsOpen = true;
    Serial.println("Door opened");
  }
}

void closeDoor() {
  if (doorIsOpen) {
    rotateMotorBackward(stepsFor120Degrees);
    doorIsOpen = false;
    Serial.println("Door closed");
  }
}
void checkFirebaseCommand() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  http.begin(String(FIREBASE_URL) + "/commands/state.json");
  int httpCode = http.GET();

  if (httpCode == 200) {
    String payload = http.getString();
    payload.trim();
    payload.replace("\"", "");

    if (payload == "open" && !doorIsOpen) {
      openDoor();
      sendToFirebase(getTimeStamp() + " Door Opened via Firebase");
    } else if (payload == "close" && doorIsOpen) {
      closeDoor();
      sendToFirebase(getTimeStamp() + " Door Closed via Firebase");
    }

    // Clear state back to idle
    HTTPClient httpClear;
    httpClear.begin(String(FIREBASE_URL) + "/commands.json");
    httpClear.addHeader("Content-Type", "application/json");
    httpClear.sendRequest("PUT", "{\"state\":\"idle\"}");
    httpClear.end();
  }

  http.end();
}



void handleLogs() {
  String js = "var L=[";
  for (int i = 0; i < logCount; i++) {
    js += "\"" + logs[i] + "\"";
    if (i < logCount - 1) js += ",";
  }
  js += "];";
  js += "var out='';L.forEach(l=>out+='<li>'+l+'</li>');";
  js += "document.getElementById('logList').innerHTML=out;";
  js += "var intr=L.filter(l=>l.indexOf('Denied')>=0);";
  js += "var out2='';intr.forEach(i=>out2+='<li>'+i+'</li>');";
    js += "fetch('/intruder-url').then(r=>r.text()).then(u=>document.getElementById('intruderImg').src=u+'&'+Date.now());";

  js += "document.getElementById('intruderList').innerHTML=out2;";
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.send(200, "application/javascript", js);
}

void setup() {
  Serial.begin(115200);
  Wire.begin(8, 9);

  pinMode(GREEN_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);
  pinMode(BUZZER_TRIGGER_OUTPUT, OUTPUT);
  pinMode(motorPin1, OUTPUT); pinMode(motorPin2, OUTPUT);
  pinMode(motorPin3, OUTPUT); pinMode(motorPin4, OUTPUT);

  display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS);
  display.clearDisplay(); display.setTextColor(SSD1306_WHITE);

  mySerial.begin(57600, SERIAL_8N1, 16, 17);
  finger.begin(57600);
  if (!finger.verifyPassword()) {
    display.println("Finger error"); display.display(); while (1);
  }

  WiFi.begin(ssid, password);
  display.setCursor(0, 0); display.println("WiFi connecting..."); display.display();
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); display.print("."); display.display();
  }

  configTime(0, 0, "pool.ntp.org");

  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("WiFi Connected!");
  display.println("IP:");
  display.println(WiFi.localIP());
  display.display();

  Serial.print("ESP32 IP: "); Serial.println(WiFi.localIP());
 camera_config_t config;
  config.ledc_channel = LEDC_CHANNEL_0;
  config.ledc_timer = LEDC_TIMER_0;
  config.pin_d0 = 11;
  config.pin_d1 = 9;
  config.pin_d2 = 8;
  config.pin_d3 = 10;
  config.pin_d4 = 12;
  config.pin_d5 = 18;
  config.pin_d6 = 17;
  config.pin_d7 = 16;
  config.pin_xclk = 15;
  config.pin_pclk = 13;
  config.pin_vsync = 6;
  config.pin_href = 7;
  config.pin_sscb_sda = 4;
  config.pin_sscb_scl = 5;
  config.pin_pwdn = -1;
  config.pin_reset = -1;
  config.xclk_freq_hz = 20000000;
  config.pixel_format = PIXFORMAT_JPEG;
  config.frame_size = FRAMESIZE_QVGA;
  config.jpeg_quality = 10;
  config.fb_count = 1;

  esp_err_t err = esp_camera_init(&config);
  if (err != ESP_OK) {
    Serial.printf("Camera init failed 0x%x", err);
    while (1);
  }
  server.on("/", [] { server.send(200, "text/plain", "Smart Door System"); });
  server.on("/logs.js", handleLogs);
  server.on("/open-door", [] { openDoor(); server.send(200, "text/plain", "Door opened"); });
  server.on("/close-door", [] { closeDoor(); server.send(200, "text/plain", "Door closed"); });
  server.begin(); Serial.println("Server started");
}

void loop() {
  server.handleClient();

  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("ðŸ‘‰ Place Finger");
  display.display();
  delay(1000);

  int id = getFingerprintID();
  String ts = getTimeStamp();
  String entry;

  if (id >= 0) {
    entry = ts + " Granted: ID " + id;
    addLog(entry);
    sendToFirebase(entry);

    display.clearDisplay();
    display.println("Access Granted"); display.print("ID: "); display.println(id); display.display();
    digitalWrite(GREEN_LED, HIGH); digitalWrite(RED_LED, LOW);
    openDoor(); delay(3000); closeDoor(); digitalWrite(GREEN_LED, LOW);
  } else {
    entry = ts + " Denied";
    addLog(entry);
    sendToFirebase(entry);

    display.clearDisplay();
    display.println("Access Denied"); display.display();
    digitalWrite(RED_LED, HIGH); digitalWrite(GREEN_LED, LOW);
    digitalWrite(BUZZER_TRIGGER_OUTPUT, HIGH); delay(1000);
    digitalWrite(BUZZER_TRIGGER_OUTPUT, LOW); delay(1000); digitalWrite(RED_LED, LOW);
    camera_fb_t* fb = esp_camera_fb_get();
    if (fb) {
      File f = SPIFFS.open("/intruder.jpg", FILE_WRITE);
      if (f) {
        f.write(fb->buf, fb->len);
        f.close();
        uploadToImgBB("/intruder.jpg");
      }
      esp_camera_fb_return(fb);
    }
    sendMailjet("Unauthorized Access", entry);
  }

checkFirebaseCommand();

  delay(1000);
}
